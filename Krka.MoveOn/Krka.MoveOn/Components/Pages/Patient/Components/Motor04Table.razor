@using Krka.MoveOn.Services.Questionnaires

@attribute [StreamRendering(true)]
@rendermode InteractiveServer

@inject Motor04Service Motor04Service
@inject Motor05Service Motor05Service

@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<div style="background-color: #f2f2f2; color: #363c41; padding: 5px; border-radius: 2px; text-align: left; font-weight: bold;">
    MDS-UPDRS škála, časť I.  – Nemotorické stránky denného života (nM-EDL)
</div>
<DxGrid @ref="nonmotGrid"
        Data="Nonmot"
        KeyFieldName="Fieldname"
        PageSize="15"
        ValidationEnabled="false"
        EditMode="GridEditMode.EditCell"
        FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
        ColumnResizeMode="GridColumnResizeMode.NextColumn"
        TextWrapEnabled="false"
        HighlightRowOnHover="true"
        EditModelSaving="OnEditModelSavingNonmot"
        FocusedRowEnabled="false">

    <Columns>
        <DxGridDataColumn FieldName="Number" Caption=" " ReadOnly="true" />
        <DxGridDataColumn FieldName="Name" Caption="Doména" ReadOnly="true" />
        <DxGridDataColumn FieldName="Value" Caption="Počet bodov" ReadOnly="@isReadOnly" DataRowEditorVisible="@(!isReadOnly)">
            <EditSettings>
                <DxSpinEditSettings MinValue="0" MaxValue="4" />
            </EditSettings>
        </DxGridDataColumn>
    </Columns>

    <TotalSummary>
        <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="Value" ValueDisplayFormat=" {0}" />
    </TotalSummary>
</DxGrid>


@code {
    [Parameter]
    [EditorRequired]
    public string questionnaireId { get; set; }

    IGrid nonmotGrid { get; set; }

    public List<MDSItem>? Nonmot { get; set; }

    Dictionary<Data.Questionnaires.QuestionnaireNonMotor04, DataChange> UnsavedChanges { get; } = new();
    bool BatchItemsEnabled => UnsavedChanges.Count > 0 || nonmotGrid.IsEditing();

    bool isReadOnly = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.IsInRole("Office"))
        {
            isReadOnly = true;
        }

        var nonmot = await Motor04Service.GetQuestionnaireNonMotor04(questionnaireId);
        Nonmot = new List<MDSItem>();


        #region "Table nonmot"

        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_1", Number = "1.1", Name = "Zhoršenie kognitívnych funkcií", Value = (nonmot != null) ? nonmot.Nonmot_1 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_2", Number = "1.2", Name = "Halucinácie a psychózy", Value = (nonmot != null) ? nonmot.Nonmot_2 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_3", Number = "1.3", Name = "Depresívna nálada", Value = (nonmot != null) ? nonmot.Nonmot_3 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_4", Number = "1.4", Name = "Úzkostná nálada", Value = (nonmot != null) ? nonmot.Nonmot_4 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_5", Number = "1.5", Name = "Apatia", Value = (nonmot != null) ? nonmot.Nonmot_5 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_6", Number = "1.6", Name = "Prejavy syndrómu dopamínovej dysregulácie", Value = (nonmot != null) ? nonmot.Nonmot_6 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_7", Number = "1.7", Name = "Problémy so spánkom", Value = (nonmot != null) ? nonmot.Nonmot_7 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_8", Number = "1.8", Name = "Denná spavosť", Value = (nonmot != null) ? nonmot.Nonmot_8 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_9", Number = "1.9", Name = "Bolesť a iné poruchy citlivosti", Value = (nonmot != null) ? nonmot.Nonmot_9 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_10", Number = "1.10", Name = "Problémy s močením", Value = (nonmot != null) ? nonmot.Nonmot_10 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_11", Number = "1.11", Name = "Problémy so zápchou", Value = (nonmot != null) ? nonmot.Nonmot_11 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_12", Number = "1.12", Name = "Závrativosť pri zmene polohy tela", Value = (nonmot != null) ? nonmot.Nonmot_12 : 0 });
        Nonmot.Add(new MDSItem() { Fieldname = "Nonmot_13", Number = "1.13", Name = "Únava", Value = (nonmot != null) ? nonmot.Nonmot_13 : 0 });
        #endregion

    }


    #region "Saving nonmot table"

    private async Task OnEditModelSavingNonmot(GridEditModelSavingEventArgs e)
    {
        var item = (MDSItem)e.EditModel;
        var questionnaire = await Motor04Service.GetQuestionnaireNonMotor04(questionnaireId) ?? new Data.Questionnaires.QuestionnaireNonMotor04
            {
                Nonmot_1 = 0,
                Nonmot_2 = 0,
                Nonmot_3 = 0,
                Nonmot_4 = 0,
                Nonmot_5 = 0,
                Nonmot_6 = 0,
                Nonmot_7 = 0,
                Nonmot_8 = 0,
                Nonmot_9 = 0,
                Nonmot_10 = 0,
                Nonmot_11 = 0,
                Nonmot_12 = 0,
                Nonmot_13 = 0,
                Questionnaire_id = questionnaireId,
                CreatedAt = DateTime.Now,
                ModifiedAt = DateTime.Now
            };

        switch (item.Fieldname)
        {
            case "Nonmot_1":
                questionnaire.Nonmot_1 = item.Value;
                break;
            case "Nonmot_2":
                questionnaire.Nonmot_2 = item.Value;
                break;
            case "Nonmot_3":
                questionnaire.Nonmot_3 = item.Value;
                break;
            case "Nonmot_4":
                questionnaire.Nonmot_4 = item.Value;
                break;
            case "Nonmot_5":
                questionnaire.Nonmot_5 = item.Value;
                break;
            case "Nonmot_6":
                questionnaire.Nonmot_6 = item.Value;
                break;
            case "Nonmot_7":
                questionnaire.Nonmot_7 = item.Value;
                break;
            case "Nonmot_8":
                questionnaire.Nonmot_8 = item.Value;
                break;
            case "Nonmot_9":
                questionnaire.Nonmot_9 = item.Value;
                break;
            case "Nonmot_10":
                questionnaire.Nonmot_10 = item.Value;
                break;
            case "Nonmot_11":
                questionnaire.Nonmot_11 = item.Value;
                break;
            case "Nonmot_12":
                questionnaire.Nonmot_12 = item.Value;
                break;
            case "Nonmot_13":
                questionnaire.Nonmot_13 = item.Value;
                break;
        }

        await Motor04Service.SaveOrUpdateQuestionnaireNonMotor04(questionnaire);
        // Navigation.NavigateTo($"/entryQ/motor/{questionnaireId}", forceLoad: true);
    }

    #endregion


    record DataChange(DataChangeType Type, HashSet<string> ChangedFields);
    enum DataChangeType { Modification }
}
