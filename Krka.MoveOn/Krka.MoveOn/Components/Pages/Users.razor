@page "/users"

@using Krka.MoveOn.Components.Account.Shared
@using Krka.MoveOn.Data
@using Krka.MoveOn.Services.Pages
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@inject UserService UserService

@attribute [Authorize(Roles = "Admin")]
@attribute [StreamRendering(true)]
@rendermode InteractiveServer

@implements IDisposable

<PageTitle>Používatelia</PageTitle>
<h3>Používatelia</h3>

@if (DataSource == null)
{
    <p><em>Načítavanie...</em></p>
}
else
{
    <style>
        .grid-popup {
            min-width: 800px;
        }
    </style>
    <StatusMessage Message="@Message" />
    <DxGrid @ref="Grid" Data="@DataSource" CssClass="mw-1100"
            PageSize="20"
            PagerPosition="GridPagerPosition.Bottom"
            PageSizeSelectorVisible="true"
            PageSizeSelectorItems="@(new int[] { 10, 20, 100 })"
            PageSizeSelectorAllRowsItemVisible="true"
            PagerSwitchToInputBoxButtonCount="10"
            PagerVisibleNumericButtonCount="10"
            ValidationEnabled="true"
            PopupEditFormHeaderText="@editFormHeaderText"
            PopupEditFormCssClass="grid-popup"
            EditMode="GridEditMode.PopupEditForm"
            EditStart="@OnRowEditStart"
            EditFormButtonsVisible="true"
            FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
            ColumnResizeMode="GridColumnResizeMode.NextColumn"
            CustomizeEditModel="Grid_CustomizeEditModel"
            EditModelSaving="Grid_EditModelSaving"
            DataItemDeleting="Grid_DataItemDeleting"
            TextWrapEnabled="false"
            HighlightRowOnHover="true">
        <Columns>
            <DxGridDataColumn Caption="Používateľ" FieldName="FullName" />
            <DxGridDataColumn Caption="Úroveň" FieldName="Role">
                <EditSettings>
                    <DxComboBoxSettings Data="@roles" />
                </EditSettings>
            </DxGridDataColumn>
            <DxGridDataColumn Caption="E-mail" FieldName="Email" />
            <DxGridDataColumn Caption="Telefón" FieldName="PhoneNumber" />
            <DxGridCommandColumn Width="100px" NewButtonVisible="false">
                <HeaderTemplate>
                    <div class="grid-header-align-center">
                        <DxButton IconCssClass="grid-icon grid-icon-add"
                                  RenderStyle="ButtonRenderStyle.Link"
                                  title="Pridať nového používateľa"
                                  Click="@(() => Grid!.StartEditNewRowAsync())" />
                    </div>
                </HeaderTemplate>
                <CellDisplayTemplate Context="gridContext">
                    <div class="grid-cell-align-center">
                        <DxButton IconCssClass="grid-icon grid-icon-edit"
                                  RenderStyle="ButtonRenderStyle.Link"
                                  title="Upraviť údaje používateľa"
                                  Click="@(() => Grid!.StartEditDataItemAsync(gridContext.DataItem))" />
                        <DxButton IconCssClass="grid-icon grid-icon-delete"
                                  RenderStyle="ButtonRenderStyle.Link"
                                  title="Vymazať používateľa"
                                  Click="@(() => Grid!.ShowRowDeleteConfirmation(gridContext.VisibleIndex))" />
                    </div>
                </CellDisplayTemplate>
                <CellEditTemplate Context="editContext">
                    <div class="grid-cell-align-center">
                        <DxButton Enabled="false"
                                  aria-label="Delete"
                                  CssClass="grid-disabled-button"
                                  IconCssClass="grid-icon grid-icon-delete"
                                  RenderStyle="ButtonRenderStyle.Link" />
                    </div>
                </CellEditTemplate>
            </DxGridCommandColumn>
        </Columns>
        <EditFormTemplate Context="EditFormContext">
            @{
                var user = (ApplicationUser)EditFormContext.EditModel;
            }
            <DxFormLayout CssClass="w-100">
                <DxFormLayoutItem Caption="Používateľské meno / e-mail:" ColSpanMd="6">
                    <DxTextBox @bind-Text="user.UserName"/>
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Úroveň:" ColSpanMd="6">
                    @EditFormContext.GetEditor("Role")
                </DxFormLayoutItem>
                @{
                    if (isNewUser)
                    {
                        <DxFormLayoutItem Caption="Heslo:" ColSpanMd="6">
                            <DxTextBox @bind-Text="user.Password" />
                        </DxFormLayoutItem>
                        <DxFormLayoutItem Caption="Potvrdenie hesla:" ColSpanMd="6">
                            <DxTextBox @bind-Text="user.ConfirmPassword" />
                        </DxFormLayoutItem>
                    }
                }
                <DxFormLayoutItem Caption="Titul pred menom:" ColSpanMd="6">
                    <DxTextBox @bind-Text="user.TitleBefore" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Titul pred menom:" ColSpanMd="6">
                    <DxTextBox @bind-Text="user.TitleAfter" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Krstné meno:" ColSpanMd="6">
                    <DxTextBox @bind-Text="user.FirstName" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Priezvisko:" ColSpanMd="6">
                    <DxTextBox @bind-Text="user.LastName" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Titul za menom:" ColSpanMd="6">
                    <DxTextBox @bind-Text="user.TitleAfter" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Phone:" ColSpanMd="6">
                    @EditFormContext.GetEditor("PhoneNumber")
                </DxFormLayoutItem>
                @* <DxFormLayoutItem ColSpanMd="12">
                    <div class="grid-cell-align-center">
                        <DxButton SubmitFormOnClick="true" Text="Uložiť" />
                        <DxButton Click="@(() => Grid!.CancelEditAsync())" Text="Zrušiť zmeny" />
                    </div>
                </DxFormLayoutItem> *@
            </DxFormLayout>
        </EditFormTemplate>
    </DxGrid>
}

@code {
    private IGrid? Grid { get; set; }
    private List<ApplicationUser>? DataSource;
    private List<IdentityRole> roles = [];
    private bool isNewUser = false;
    private TaskCompletionSource<bool> DataLoadedTcs { get; } = new(TaskCreationOptions.RunContinuationsAsynchronously);
    private string editFormHeaderText = "Nový používateľ";
    private List<IdentityError> identityErrors = [];
    private string? Message => identityErrors.Count() == 0 ? null : $"Chyba: {string.Join(", ", identityErrors.Select(error => error.Description))}";

    protected override async Task OnInitializedAsync()
    {
        DataSource = await UserService.GetUsersAsync();
        roles = await UserService.GetRolesAsync();
        DataLoadedTcs.TrySetResult(true);
    }

    private void Grid_CustomizeEditModel(GridCustomizeEditModelEventArgs e)
    {
        isNewUser = false;
        if (e.IsNew)
        {
            isNewUser = true;
            var newUser = (ApplicationUser)e.EditModel;
            newUser.Role = roles.First(i => i.Name == "Doctor");
        }
    }
    private async Task Grid_EditModelSaving(GridEditModelSavingEventArgs e)
    {
        var anUser = (ApplicationUser)e.EditModel;

        // validation
        var emailAttribute = new EmailAddressAttribute();
        if (!emailAttribute.IsValid(anUser.UserName))
            identityErrors.Add(new() { Code = "1", Description = emailAttribute.ErrorMessage });
        if (string.IsNullOrEmpty(anUser.FirstName))
            identityErrors.Add(new() { Code = "2", Description = "Krstné meno je povinný údaj" });
        if (string.IsNullOrEmpty(anUser.LastName))
            identityErrors.Add(new() { Code = "3", Description = "Priezvisko je povinný údaj" });

        // depends on acton type
        if (e.IsNew)
        {
            if (string.IsNullOrEmpty(anUser.Password) || anUser.Password.Length < 6 || anUser.Password.Length > 100)
                identityErrors.Add(new() { Code = "4", Description = "Pole Heslo musí byť aspoň 6 a maximálne 100 znakov dlhé." });
            if (!string.IsNullOrEmpty(anUser.ConfirmPassword) && !anUser.ConfirmPassword.Equals(anUser.Password))
                identityErrors.Add(new() { Code = "5", Description = "Heslo a potvrdzovacie heslo sa nezhodujú.." });
        }
        // await NwindDataService.InsertSupplierAsync((Supplier)e.EditModel);
        // else
        //     await NwindDataService.UpdateSupplierAsync((Supplier)e.DataItem, (Supplier)e.EditModel);
        // await UpdateDataAsync();
    }
    private async Task Grid_DataItemDeleting(GridDataItemDeletingEventArgs e)
    {
        // await NwindDataService.RemoveSupplierAsync((Supplier)e.DataItem);
        // await UpdateDataAsync();
    }

    private Task OnRowEditStart(GridEditStartEventArgs e)
    {
        if (e.IsNew)
            editFormHeaderText = "Nový používateľ";
        else
        {
            var anUser = (ApplicationUser)e.DataItem;
            if (anUser != null)
                editFormHeaderText = $"Používateľ {anUser.FullName}";
        }
        StateHasChanged();
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        DataLoadedTcs.TrySetCanceled();
    }

}
