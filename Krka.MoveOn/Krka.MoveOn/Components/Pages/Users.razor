@page "/users"

@using Krka.MoveOn.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@attribute [Authorize(Roles = "Admin")]

<PageTitle>Používatelia</PageTitle>
<h3>Používatelia</h3>

@if (users == null)
{
    <p><em>Načítavanie...</em></p>
}
else
{
    <DxGrid Data="@users" CssClass="mw-1100">
        <Columns>
            <DxGridDataColumn Caption="Používateľ" FieldName="FullName" />
            <DxGridDataColumn Caption="Úroveň" FieldName="Role" />
            <DxGridDataColumn Caption="Last Name" FieldName="LastName" />
            <DxGridDataColumn Caption="UserName" FieldName="UserName" />
        </Columns>
    </DxGrid>
}

@code {
    private ApplicationUser[]? users;

    protected override async Task OnInitializedAsync()
    {
        users = await Task.Run(() => UserManager.Users.ToArray());
        var tasks = users.Select(async user =>
        {
            var roles = await UserManager.GetRolesAsync(user);
            user.Role = roles.First();
        });
        await Task.WhenAll(tasks);
    }
}
