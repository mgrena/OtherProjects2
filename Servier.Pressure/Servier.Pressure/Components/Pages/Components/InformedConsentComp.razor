@using System.IdentityModel.Claims
@using System.ComponentModel.DataAnnotations
@using Servier.Pressure.Components.Account.Shared
@using Servier.Pressure.Data.Models
@using Servier.Pressure.Helpers
@using Servier.Pressure.Services.Pages

@attribute [StreamRendering(true)]
@rendermode InteractiveServer

@inject IToastNotificationService ToastService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject QuestionnaireService QuestionnaireService

@if (InformedConsentCompetenceQuestionary == null)
{
    <p><em>Načítavanie...</em></p>
}
else
{
    <EditForm Model="@InformedConsentCompetenceQuestionary" Context="EditFormContext">
        <DxFormLayout CssClass="w-100">
            <DxFormLayoutGroup Caption="Informovaný súhlas" ColSpanMd="12" CaptionCssClass="caption-styleH0">
                <DxFormLayoutItem Caption="Dátum návštevy" ColSpanMd="12" CaptionCssClass="caption-styleH1">
                    <DxDateEdit @bind-Date="@VisitDate" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Podpis formulára informovaného súhlasu" ColSpanMd="12" CaptionCssClass="caption-styleH1">
                    <DxRadioGroup Layout="@RadioGroupLayout.Horizontal" Items="@ConsentOption" @bind-Value="@IsConsent" TextFieldName="DisplayText" ValueFieldName="Value" />
                </DxFormLayoutItem>
            </DxFormLayoutGroup>
            <DxFormLayoutGroup Caption="Zaraďovacie kritériá" ColSpanMd="12" CaptionCssClass="caption-styleH0">
                <DxFormLayoutItem Caption="Zaradení môžu byť len pacienti spĺňajúci všetky zaraďovacie kritériá." ColSpanMd="12" CaptionCssClass="caption-styleH1" />
                <DxFormLayoutItem Caption="Muž alebo žena vo veku ≥ 18 rokov" ColSpanMd="12" CaptionCssClass="caption-styleH1">
                    <DxRadioGroup Layout="@RadioGroupLayout.Horizontal" Items="@ConsentOption" @bind-Value="@IsAdult" TextFieldName="DisplayText" ValueFieldName="Value" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Pacient s artériovou hypertenziou farmakologicky liečenou ≥ 12 mesiacov a bez zmien antihypertenzívnej liečby v priebehu 3 mesiacov" ColSpanMd="12" CaptionCssClass="caption-styleH1">
                    <DxRadioGroup Layout="@RadioGroupLayout.Horizontal" Items="@ConsentOption" @bind-Value="@IsStableHypertension" TextFieldName="DisplayText" ValueFieldName="Value" />
                </DxFormLayoutItem>
            </DxFormLayoutGroup>
            <DxFormLayoutGroup Caption="Vylučovacie kritériá" ColSpanMd="12" CaptionCssClass="caption-styleH0">
                <DxFormLayoutItem Caption="Zaradení môžu byť len pacienti, ktorí nespĺňajú nižšie uvedené vylučovacie kritériá:" ColSpanMd="12" CaptionCssClass="caption-styleH1" />
                <DxFormLayoutItem Caption="Pacient už zaradený do tejto štúdie" ColSpanMd="12" CaptionCssClass="caption-styleH1">
                    <DxRadioGroup Layout="@RadioGroupLayout.Horizontal" Items="@ConsentOption" @bind-Value="@IsAlreadyEnrolled" TextFieldName="DisplayText" ValueFieldName="Value" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Prítomnosť rezistentnej hypertenzie" ColSpanMd="12" CaptionCssClass="caption-styleH1">
                    <DxRadioGroup Layout="@RadioGroupLayout.Horizontal" Items="@ConsentOption" @bind-Value="@IsResistantHypertension" TextFieldName="DisplayText" ValueFieldName="Value" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Účasť v intervenčnom klinickom skúšaní (aktuálne alebo v priebehu 30 dní pred Návštevou 1)" ColSpanMd="12" CaptionCssClass="caption-styleH1">
                    <DxRadioGroup Layout="@RadioGroupLayout.Horizontal" Items="@ConsentOption" @bind-Value="@IsClinicalTrial" TextFieldName="DisplayText" ValueFieldName="Value" />
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="Pacientka, ktorá je tehotná, dojčí alebo plánuje otehotnieť v priebehu nasledujúcich 3 mesiacov" ColSpanMd="12" CaptionCssClass="caption-styleH1">
                    <DxRadioGroup Layout="@RadioGroupLayout.Horizontal" Items="@ConsentOption" @bind-Value="@IsPregnant" TextFieldName="DisplayText" ValueFieldName="Value" />
                </DxFormLayoutItem>
            </DxFormLayoutGroup>
        </DxFormLayout>
    </EditForm>
    <StatusMessage Message="@Message" />
}
@code {
    [Parameter]
    public required string patientId { get; set; }
    private string? Message;

    public Data.Models.InformedConsentCompetence? InformedConsentCompetenceQuestionary { get; set; }
    private IEnumerable<ConsentOptions> ConsentOption { get; set; } = new List<ConsentOptions>
    {
        new ConsentOptions { DisplayText = "Áno", Value = true },
        new ConsentOptions { DisplayText = "Nie", Value = false }
    };
    public class ConsentOptions
    {
        public string DisplayText { get; set; }
        public bool Value { get; set; }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            InformedConsentCompetenceQuestionary = await QuestionnaireService.GetInformedConsentCompetenceByIdAsync(patientId);
            await InvokeAsync(StateHasChanged);
        }
    }

    private System.Timers.Timer? debounceTimer;
    private async Task OnFieldChangedAsync()
    {
        // Ak existuje starý timer, zastaviť ho
        debounceTimer?.Stop();

        // Nový timer na 1 sekundu
        debounceTimer = new System.Timers.Timer(1000);
        debounceTimer.AutoReset = false;
        debounceTimer.Elapsed += async (s, e) =>
        {
            var result = await QuestionnaireService.SaveInformedConsentCompetenceQuestionaryAsync(InformedConsentCompetenceQuestionary!);
            if (!result.Success)
                Message = string.Format("{0} {1}", result.ErrorMessage, result.AdditionalInfo);
            else
                ModifyToast();
        };
        debounceTimer.Start();

        // Await the timer to avoid CS1998 warning
        await Task.CompletedTask;
    }

    private DateTime VisitDate
    {
        get => InformedConsentCompetenceQuestionary!.VisitDate;
        set
        {
            if (InformedConsentCompetenceQuestionary!.VisitDate != value)
            {
                InformedConsentCompetenceQuestionary!.VisitDate = value;
                InvokeAsync(OnFieldChangedAsync);
            }
        }
    }
    private bool IsConsent
    {
        get => InformedConsentCompetenceQuestionary!.IsConsent;
        set
        {
            if (InformedConsentCompetenceQuestionary!.IsConsent != value)
            {
                InformedConsentCompetenceQuestionary!.IsConsent = value;
                InvokeAsync(OnFieldChangedAsync);
            }
        }
    }
    private bool IsAdult
    {
        get => InformedConsentCompetenceQuestionary!.IsAdult;
        set
        {
            if (InformedConsentCompetenceQuestionary!.IsAdult != value)
            {
                InformedConsentCompetenceQuestionary!.IsAdult = value;
                InvokeAsync(OnFieldChangedAsync);
            }
        }
    }
    private bool IsStableHypertension
    {
        get => InformedConsentCompetenceQuestionary!.IsStableHypertension;
        set
        {
            if (InformedConsentCompetenceQuestionary!.IsStableHypertension != value)
            {
                InformedConsentCompetenceQuestionary!.IsStableHypertension = value;
                InvokeAsync(OnFieldChangedAsync);
            }
        }
    }
    private bool IsInformedConsent
    {
        get => InformedConsentCompetenceQuestionary!.IsInformedConsent;
        set
        {
            if (InformedConsentCompetenceQuestionary!.IsInformedConsent != value)
            {
                InformedConsentCompetenceQuestionary!.IsInformedConsent = value;
                InvokeAsync(OnFieldChangedAsync);
            }
        }
    }
    private bool IsAlreadyEnrolled
    {
        get => InformedConsentCompetenceQuestionary!.IsAlreadyEnrolled;
        set
        {
            if (InformedConsentCompetenceQuestionary!.IsAlreadyEnrolled != value)
            {
                InformedConsentCompetenceQuestionary!.IsAlreadyEnrolled = value;
                InvokeAsync(OnFieldChangedAsync);
            }
        }
    }
    private bool IsResistantHypertension
    {
        get => InformedConsentCompetenceQuestionary!.IsResistantHypertension;
        set
        {
            if (InformedConsentCompetenceQuestionary!.IsResistantHypertension != value)
            {
                InformedConsentCompetenceQuestionary!.IsResistantHypertension = value;
                InvokeAsync(OnFieldChangedAsync);
            }
        }
    }
    private bool IsClinicalTrial
    {
        get => InformedConsentCompetenceQuestionary!.IsClinicalTrial;
        set
        {
            if (InformedConsentCompetenceQuestionary!.IsClinicalTrial != value)
            {
                InformedConsentCompetenceQuestionary!.IsClinicalTrial = value;
                InvokeAsync(OnFieldChangedAsync);
            }
        }
    }
    private bool IsPregnant
    {
        get => InformedConsentCompetenceQuestionary!.IsPregnant;
        set
        {
            if (InformedConsentCompetenceQuestionary!.IsPregnant != value)
            {
                InformedConsentCompetenceQuestionary!.IsPregnant = value;
                InvokeAsync(OnFieldChangedAsync);
            }
        }
    }

    private void ModifyToast()
    {
        ToastService.ShowToast(new ToastOptions
            {
                ProviderName = "Overview",
                Title = "Údaje úspešne aktualizované",
                ThemeMode = ToastThemeMode.Saturated,
                RenderStyle = ToastRenderStyle.Success,
            });
    }

}
